<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shark Bot Trading Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>

    <style>
        /* RESET OBLIGATORIO & VARIABLES */
        :root {
            --c-deep-dark: #051F20;
            --c-dark: #0B2B26;
            --c-medium: #163832;
            --c-accent: #235347;
            --c-sage: #8EB69B;
            --c-mint: #DAF1DE;
            --c-error: #D46B6B;
            --font-main: 'Inter', sans-serif;

            --radius-xl: 32px;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
        }

        *:focus {
            outline: none;
        }

        body {
            background-color: var(--c-deep-dark);
            color: var(--c-mint);
            min-height: 100vh;
        }

        [v-cloak] {
            display: none;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--c-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--c-accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--c-sage);
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background-color: var(--c-dark);
            padding: 40px 24px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--c-accent);
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 60px;
            color: var(--c-mint);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: var(--radius-md);
            color: var(--c-sage);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: var(--c-medium);
            color: var(--c-mint);
        }

        .nav-item i {
            font-size: 20px;
        }

        .sidebar-footer {
            margin-top: auto;
        }

        .user-mini {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background-color: var(--c-medium);
            border-radius: var(--radius-lg);
        }

        .avatar {
            width: 40px;
            height: 40px;
            background-color: var(--c-sage);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--c-deep-dark);
            font-weight: bold;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 32px;
            overflow-y: auto;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 101;
            background-color: var(--c-medium);
            border: 1px solid var(--c-accent);
            color: var(--c-mint);
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .welcome-text h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--c-mint);
        }

        .welcome-text p {
            color: var(--c-sage);
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: 50px;
            border: none;
            font-family: var(--font-main);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--c-sage);
            color: var(--c-deep-dark);
        }

        .btn-primary:hover {
            background-color: #A3C6AF;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--c-accent);
            color: var(--c-mint);
            border: 1px solid transparent;
        }

        .btn-secondary:hover {
            background-color: var(--c-medium);
            border-color: var(--c-sage);
            transform: translateY(-2px);
        }

        /* --- INPUTS --- */
        .input-wrapper {
            position: relative;
            width: 100%;
            max-width: 320px;
        }

        .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--c-sage);
            font-size: 18px;
            pointer-events: none;
        }

        .form-input {
            width: 100%;
            background-color: var(--c-medium);
            color: var(--c-mint);
            border: 1px solid var(--c-accent);
            padding: 14px 20px 14px 48px;
            border-radius: 50px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input::placeholder {
            color: var(--c-sage);
            opacity: 0.7;
        }

        .form-input:focus {
            border-color: var(--c-sage);
        }

        /* --- BADGES --- */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            line-height: 1;
        }

        .badge-up {
            background-color: rgba(218, 241, 222, 0.1);
            color: var(--c-mint);
            border: 1px solid var(--c-accent);
        }

        .badge-down {
            background-color: rgba(212, 107, 107, 0.1);
            color: var(--c-error);
            border: 1px solid rgba(212, 107, 107, 0.3);
        }

        /* --- CARDS --- */
        .card {
            background-color: var(--c-medium);
            border-radius: var(--radius-xl);
            padding: 24px;
            border: 1px solid var(--c-accent);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--c-mint);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title-bar {
            width: 4px;
            height: 20px;
            border-radius: 2px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--c-sage);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .btn-icon:hover {
            background-color: var(--c-accent);
            color: var(--c-mint);
        }

        /* --- KPI CARDS GRID --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: linear-gradient(135deg, var(--c-medium) 0%, var(--c-dark) 100%);
            padding: 24px;
            border-radius: var(--radius-xl);
            border: 1px solid var(--c-accent);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .kpi-label {
            color: var(--c-sage);
            font-size: 13px;
            font-weight: 500;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kpi-icon.green {
            background-color: rgba(142, 182, 155, 0.15);
            color: var(--c-sage);
        }

        .kpi-icon.blue {
            background-color: rgba(99, 179, 237, 0.15);
            color: #63b3ed;
        }

        .kpi-icon.purple {
            background-color: rgba(183, 148, 244, 0.15);
            color: #b794f4;
        }

        .kpi-icon.yellow {
            background-color: rgba(236, 201, 75, 0.15);
            color: #ecc94b;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--c-mint);
            margin-bottom: 4px;
        }

        .kpi-subtitle {
            color: var(--c-sage);
            font-size: 12px;
        }

        .text-positive {
            color: var(--c-mint);
        }

        .text-negative {
            color: var(--c-error);
        }

        /* Balance Hero Card */
        .balance-hero {
            background: linear-gradient(135deg, var(--c-medium) 0%, var(--c-dark) 100%);
            padding: 32px;
            border-radius: var(--radius-xl);
            border: 1px solid var(--c-accent);
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
        }

        .balance-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 60%;
            height: 200%;
            background: radial-gradient(circle, rgba(142, 182, 155, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }

        .balance-label {
            color: var(--c-sage);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: 700;
            color: var(--c-mint);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .actions-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        /* Time Filters */
        .time-filters-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: var(--c-dark);
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--c-accent);
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .filter-label {
            color: var(--c-sage);
            font-size: 14px;
            font-weight: 500;
        }

        .time-filters {
            display: flex;
            gap: 8px;
            background-color: var(--c-medium);
            padding: 4px;
            border-radius: 20px;
        }

        .filter-btn {
            padding: 8px 20px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            color: var(--c-sage);
            background: transparent;
            border: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            color: var(--c-mint);
        }

        .filter-btn.active {
            background-color: var(--c-sage);
            color: var(--c-deep-dark);
            font-weight: 600;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-container {
            background-color: var(--c-medium);
            border-radius: var(--radius-xl);
            padding: 24px;
            border: 1px solid var(--c-accent);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--c-mint);
        }

        .chart-subtitle {
            font-size: 12px;
            color: var(--c-sage);
        }

        .chart-viz {
            height: 280px;
            position: relative;
        }

        /* Sections Grid */
        .sections-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .section-full {
            grid-column: 1 / -1;
        }

        /* Market Data */
        .market-item {
            background-color: var(--c-dark);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--c-accent);
            margin-bottom: 12px;
        }

        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .market-symbol {
            font-weight: 700;
            font-size: 16px;
            color: var(--c-mint);
        }

        .market-price {
            color: var(--c-sage);
            font-family: monospace;
            font-size: 16px;
        }

        .market-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .market-stat {
            display: flex;
            flex-direction: column;
        }

        .market-stat-label {
            color: var(--c-sage);
            font-size: 11px;
            opacity: 0.7;
        }

        .market-stat-value {
            font-family: monospace;
            font-size: 13px;
            font-weight: 600;
        }

        /* Prompt Section */
        .prompt-content {
            background-color: var(--c-dark);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--c-accent);
            font-size: 12px;
            color: var(--c-sage);
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }

        /* Agent Response */
        .agent-content {
            background-color: var(--c-dark);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--c-accent);
            max-height: 400px;
            overflow-y: auto;
        }

        .markdown-body {
            color: var(--c-sage);
            font-size: 14px;
            line-height: 1.7;
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            color: var(--c-mint);
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .markdown-body h1 {
            font-size: 1.4em;
        }

        .markdown-body h2 {
            font-size: 1.2em;
        }

        .markdown-body h3 {
            font-size: 1.1em;
        }

        .markdown-body p {
            margin-bottom: 1em;
        }

        .markdown-body ul,
        .markdown-body ol {
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-body strong {
            color: var(--c-mint);
            font-weight: 600;
        }

        .markdown-body code {
            background: var(--c-accent);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .markdown-body pre {
            background: var(--c-deep-dark);
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        /* Positions Grid */
        .positions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .position-card {
            background-color: var(--c-dark);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--c-accent);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .position-symbol {
            font-weight: 700;
            color: var(--c-mint);
        }

        .position-side {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .position-side.long {
            background-color: rgba(142, 182, 155, 0.2);
            color: var(--c-sage);
        }

        .position-side.short {
            background-color: rgba(212, 107, 107, 0.2);
            color: var(--c-error);
        }

        .position-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .position-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .position-label {
            color: var(--c-sage);
        }

        .position-value {
            color: var(--c-mint);
            font-family: monospace;
        }

        /* Operations Log */
        .operations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .operation-item {
            background-color: var(--c-dark);
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--c-accent);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
        }

        .operation-item:hover {
            background-color: var(--c-accent);
        }

        .operation-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .operation-type {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .operation-type.open-long {
            background-color: rgba(142, 182, 155, 0.2);
            color: var(--c-sage);
        }

        .operation-type.open-short {
            background-color: rgba(212, 107, 107, 0.2);
            color: var(--c-error);
        }

        .operation-type.close {
            background-color: rgba(99, 179, 237, 0.2);
            color: #63b3ed;
        }

        .operation-currency {
            font-weight: 700;
            color: var(--c-mint);
        }

        .operation-details {
            color: var(--c-sage);
            font-size: 13px;
        }

        .operation-status {
            font-size: 11px;
            font-weight: 600;
        }

        .operation-status.success {
            color: var(--c-sage);
        }

        .operation-status.error {
            color: var(--c-error);
        }

        .operation-status.pending {
            color: #ecc94b;
        }

        .operation-time {
            color: var(--c-sage);
            font-size: 12px;
            opacity: 0.7;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--c-sage);
        }

        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Loading Spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .sections-grid {
                grid-template-columns: 1fr;
            }

            .positions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.open {
                display: block;
            }

            .mobile-menu-btn {
                display: flex;
            }

            .main-content {
                margin-left: 0;
                padding: 80px 16px 32px 16px;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
            }

            .input-wrapper {
                max-width: 100%;
            }

            .balance-amount {
                font-size: 32px;
            }

            .actions-row {
                flex-direction: column;
            }

            .actions-row .btn {
                width: 100%;
            }

            .time-filters-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .time-filters {
                overflow-x: auto;
                width: 100%;
                justify-content: flex-start;
            }

            .positions-grid {
                grid-template-columns: 1fr;
            }

            .kpi-value {
                font-size: 24px;
            }
        }
    </style>
</head>

<body>
    <script>
        // Django context variable passed to JavaScript
        window.DJANGO_API_BASE_URL = "{{ api_base_url }}";
    </script>
    {% verbatim %}
    <div id="app" v-cloak class="app-container">

        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" @click="toggleSidebar">
            <i class="ph ph-list" style="font-size: 24px;"></i>
        </button>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" :class="{ open: sidebarOpen }" @click="toggleSidebar"></div>

        <!-- SIDEBAR -->
        <nav class="sidebar" :class="{ open: sidebarOpen }">
            <div class="logo">
                <i class="ph ph-shark" style="color: var(--c-sage); font-size: 28px;"></i>
                SharkBot
            </div>



            <div class="sidebar-footer">
                <div class="user-mini">
                    <div class="avatar">SB</div>
                    <div style="font-size: 14px;">
                        <div style="color: var(--c-mint);">Shark Bot</div>
                        <div style="color: var(--c-sage); font-size: 12px;">Trading Activo</div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">

            <!-- HEADER -->
            <header class="header">
                <div class="welcome-text">
                    <h1>Portfolio</h1>
                    <p>{{ currentDate }}</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" @click="fetchData" :disabled="loading">
                        <i v-if="loading" class="ph ph-circle-notch spinner"></i>
                        <template v-else>
                            <i class="ph ph-arrows-clockwise"></i>
                            Actualizar
                        </template>
                    </button>
                </div>
            </header>

            <!-- BALANCE HERO CARD -->
            <div class="balance-hero">
                <div class="balance-label">Balance Total</div>
                <div class="balance-amount">
                    ${{ latestExecution ? formatMoney(latestExecution.summary?.total_balance) : '0.00' }}
                    <span class="badge" :class="getDailyPnl >= 0 ? 'badge-up' : 'badge-down'">
                        <i :class="getDailyPnl >= 0 ? 'ph ph-trend-up' : 'ph ph-trend-down'"></i>
                        {{ getDailyPnlPercent }}%
                    </span>
                </div>
            </div>

            <!-- KPI CARDS -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-label">Disponible</span>
                        <div class="kpi-icon green">
                            <i class="ph ph-wallet"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        ${{ latestExecution ? formatMoney(latestExecution.summary?.available_balance) : '0.00' }}
                    </div>
                    <div class="kpi-subtitle">Balance disponible para trading</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-label">PnL del Día</span>
                        <div class="kpi-icon blue">
                            <i class="ph ph-chart-bar"></i>
                        </div>
                    </div>
                    <div class="kpi-value" :class="getDailyPnl >= 0 ? 'text-positive' : 'text-negative'">
                        ${{ latestExecution ? formatMoney(latestExecution.summary?.daily_pnl) : '0.00' }}
                    </div>
                    <div class="kpi-subtitle">
                        {{ latestExecution ? latestExecution.summary?.trade_count : 0 }} operaciones hoy
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-label">Win Rate</span>
                        <div class="kpi-icon purple">
                            <i class="ph ph-target"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        {{ latestExecution ? latestExecution.summary?.win_rate.toFixed(1) : '0.0' }}%
                    </div>
                    <div class="kpi-subtitle" v-if="latestExecutionDetails?.daily_pnl">
                        {{ latestExecutionDetails.daily_pnl.winning_trades }}W /
                        {{ latestExecutionDetails.daily_pnl.losing_trades }}L
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-label">Posiciones Abiertas</span>
                        <div class="kpi-icon yellow">
                            <i class="ph ph-lightning"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        {{ latestExecution ? latestExecution.summary?.open_positions_count : 0 }}
                    </div>
                    <div class="kpi-subtitle">Activas ahora</div>
                </div>
            </div>

            <!-- TIME FILTERS -->
            <div class="time-filters-container">
                <span class="filter-label">Período:</span>
                <div class="time-filters">
                    <button class="filter-btn" :class="{ active: activeFilter === '24h' }"
                        @click="setFilter('24h')">24H</button>
                    <button class="filter-btn" :class="{ active: activeFilter === '7d' }"
                        @click="setFilter('7d')">7D</button>
                    <button class="filter-btn" :class="{ active: activeFilter === '30d' }"
                        @click="setFilter('30d')">1M</button>
                    <button class="filter-btn" :class="{ active: activeFilter === 'all' }"
                        @click="setFilter('all')">Todo</button>
                </div>
            </div>

            <!-- CHARTS GRID -->
            <div class="charts-grid">
                <!-- Balance Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Evolución del Balance</div>
                            <div class="chart-subtitle">Balance total en USDT</div>
                        </div>
                    </div>
                    <div class="chart-viz">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>

                <!-- Win Rate Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Rendimiento Diario</div>
                            <div class="chart-subtitle">Win Rate por sesión</div>
                        </div>
                    </div>
                    <div class="chart-viz">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- PnL Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">PnL Acumulado</div>
                            <div class="chart-subtitle">Ganancias y pérdidas diarias</div>
                        </div>
                    </div>
                    <div class="chart-viz">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>

                <!-- Activity Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Actividad de Trading</div>
                            <div class="chart-subtitle">Número de operaciones</div>
                        </div>
                    </div>
                    <div class="chart-viz">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- AGENT ANALYSIS -->
            <div class="card section-full" style="margin-bottom: 32px;">
                <div class="card-header">
                    <h3 class="card-title">
                        <span class="card-title-bar" style="background-color: #ed8936;"></span>
                        Análisis del Agente IA
                    </h3>
                    <button class="btn-icon"><i class="ph ph-brain"></i></button>
                </div>
                <div v-if="latestExecutionDetails?.agent_response" class="agent-content">
                    <div class="markdown-body" v-html="renderMarkdown(latestExecutionDetails.agent_response)"></div>
                </div>
                <div v-else class="empty-state">
                    <i class="ph ph-robot" style="font-size: 40px; opacity: 0.3;"></i>
                    <p>Cargando análisis...</p>
                </div>
            </div>

            <!-- MARKET DATA & PROMPT SECTION -->
            <div class="sections-grid">
                <!-- Market Data -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span class="card-title-bar" style="background-color: #63b3ed;"></span>
                            Datos de Mercado
                        </h3>
                        <button class="btn-icon"><i class="ph ph-dots-three"></i></button>
                    </div>
                    <div class="scrollable-content" v-if="latestExecutionDetails?.market_data">
                        <div class="market-item" v-for="(data, currency) in latestExecutionDetails.market_data"
                            :key="currency">
                            <div class="market-header">
                                <span class="market-symbol">{{ currency }}/USDT</span>
                                <span class="market-price">${{ formatMoney(data.price) }}</span>
                            </div>
                            <div class="market-stats">
                                <div class="market-stat">
                                    <span class="market-stat-label">RSI(14)</span>
                                    <span class="market-stat-value" :style="{ color: getRsiColor(data.rsi_14) }">
                                        {{ data.rsi_14?.toFixed(2) }}
                                    </span>
                                </div>
                                <div class="market-stat">
                                    <span class="market-stat-label">MACD</span>
                                    <span class="market-stat-value"
                                        :style="{ color: data.macd > 0 ? 'var(--c-sage)' : 'var(--c-error)' }">
                                        {{ data.macd?.toFixed(2) }}
                                    </span>
                                </div>
                                <div class="market-stat">
                                    <span class="market-stat-label">EMA(9)</span>
                                    <span class="market-stat-value" style="color: var(--c-sage);">
                                        {{ data.ema_9?.toFixed(2) }}
                                    </span>
                                </div>
                                <div class="market-stat">
                                    <span class="market-stat-label">Funding</span>
                                    <span class="market-stat-value"
                                        :style="{ color: data.funding_rate < 0 ? 'var(--c-error)' : 'var(--c-sage)' }">
                                        {{ (data.funding_rate * 100)?.toFixed(4) }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="empty-state">
                        <i class="ph ph-chart-line" style="font-size: 40px; opacity: 0.3;"></i>
                        <p>No hay datos de mercado disponibles</p>
                    </div>
                </div>





                <!-- OPEN POSITIONS -->
                <div v-if="latestExecutionDetails?.open_positions?.length > 0" class="card"
                    style="margin-bottom: 32px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span class="card-title-bar" style="background-color: var(--c-error);"></span>
                            Posiciones Abiertas
                        </h3>
                    </div>
                    <div class="positions-grid">
                        <div class="position-card" v-for="position in latestExecutionDetails.open_positions"
                            :key="position.symbol">
                            <div class="position-header">
                                <span class="position-symbol">{{ position.symbol }}</span>
                                <span class="position-side" :class="position.side === 'LONG' ? 'long' : 'short'">
                                    {{ position.side }}
                                </span>
                            </div>
                            <div class="position-details">
                                <div class="position-row">
                                    <span class="position-label">Entrada:</span>
                                    <span class="position-value">${{ position.entry_price }}</span>
                                </div>
                                <div class="position-row">
                                    <span class="position-label">Cantidad:</span>
                                    <span class="position-value">{{ position.quantity }}</span>
                                </div>
                                <div class="position-row">
                                    <span class="position-label">Leverage:</span>
                                    <span class="position-value">{{ position.leverage }}x</span>
                                </div>
                                <div class="position-row">
                                    <span class="position-label">PnL:</span>
                                    <span class="position-value"
                                        :class="position.unrealized_pnl >= 0 ? 'text-positive' : 'text-negative'">
                                        ${{ position.unrealized_pnl?.toFixed(2) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OPERATIONS LOG -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span class="card-title-bar" style="background-color: #667eea;"></span>
                            Registro de Operaciones
                        </h3>
                        <button class="btn-icon"><i class="ph ph-funnel"></i></button>
                    </div>
                    <div class="operations-list" v-if="operations.length > 0">
                        <div class="operation-item" v-for="op in operations.slice(0, 20)" :key="op.id">
                            <div class="operation-info">
                                <span class="operation-type"
                                    :class="{ 'open-long': op.operation_type === 'OPEN_LONG', 'open-short': op.operation_type === 'OPEN_SHORT', 'close': op.operation_type === 'CLOSE_POSITION' }">
                                    {{ op.operation_type.replace('_', ' ') }}
                                </span>
                                <span class="operation-currency">{{ op.currency }}</span>
                                <span class="operation-details" v-if="op.entry_price">@ ${{ op.entry_price }}</span>
                                <span class="operation-details" v-if="op.quantity">Qty: {{ op.quantity }}</span>
                                <span class="operation-status"
                                    :class="{ success: op.status === 'SUCCESS', error: op.status === 'ERROR', pending: op.status === 'PENDING' }">
                                    {{ op.status }}
                                </span>
                            </div>
                            <span class="operation-time">{{ formatDateTime(op.created_at) }}</span>
                        </div>
                    </div>
                    <div v-else class="empty-state">
                        <i class="ph ph-clipboard-text" style="font-size: 40px; opacity: 0.3;"></i>
                        <p>No hay operaciones registradas</p>
                    </div>
                </div>

                <!-- System Prompt -->
                <div class="card section-full">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span class="card-title-bar" style="background-color: #b794f4;"></span>
                            System Prompt
                        </h3>
                        <button class="btn-icon"><i class="ph ph-copy"></i></button>
                    </div>
                    <div v-if="latestExecutionDetails?.system_prompt" class="markdown-body"
                        v-html="renderMarkdown(latestExecutionDetails.system_prompt)"></div>
                    <div v-else class="empty-state">
                        <i class="ph ph-file-text" style="font-size: 40px; opacity: 0.3;"></i>
                        <p>No hay prompt disponible</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const loading = ref(false);
                const sidebarOpen = ref(false);
                const executions = ref([]);
                const operations = ref([]);
                const latestExecution = ref(null);
                const latestExecutionDetails = ref(null);

                const baseUrl = ref('/');

                const activeFilter = ref('7d');
                const filters = ref({
                    startDate: moment().subtract(7, 'days').startOf('day'),
                    endDate: moment().endOf('day')
                });

                const chartInstances = ref({});

                // Rate limiting: 5 minutos entre actualizaciones
                const lastUpdateTime = ref(null);
                const UPDATE_COOLDOWN_MS = 5 * 60 * 1000; // 5 minutos

                const currentDate = computed(() => {
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    return new Date().toLocaleDateString('es-ES', options);
                });

                const getDailyPnl = computed(() => {
                    return latestExecution.value?.summary?.daily_pnl || 0;
                });

                const getDailyPnlPercent = computed(() => {
                    const pnl = getDailyPnl.value;
                    const balance = latestExecution.value?.summary?.total_balance || 1;
                    return ((pnl / balance) * 100).toFixed(2);
                });

                const canUpdate = computed(() => {
                    if (!lastUpdateTime.value) return true;
                    const timeSinceLastUpdate = Date.now() - lastUpdateTime.value;
                    return timeSinceLastUpdate >= UPDATE_COOLDOWN_MS;
                });

                const timeUntilNextUpdate = computed(() => {
                    if (!lastUpdateTime.value || canUpdate.value) return 0;
                    const timeSinceLastUpdate = Date.now() - lastUpdateTime.value;
                    const timeRemaining = UPDATE_COOLDOWN_MS - timeSinceLastUpdate;
                    return Math.ceil(timeRemaining / 1000); // en segundos
                });

                const updateButtonText = computed(() => {
                    if (loading.value) return '';
                    if (canUpdate.value) return 'Actualizar';
                    const minutes = Math.floor(timeUntilNextUpdate.value / 60);
                    const seconds = timeUntilNextUpdate.value % 60;
                    return `Espera ${minutes}:${seconds.toString().padStart(2, '0')}`;
                });

                const toggleSidebar = () => {
                    sidebarOpen.value = !sidebarOpen.value;
                };

                const setFilter = (period) => {
                    activeFilter.value = period;
                    const end = moment().endOf('day');
                    let start;

                    switch (period) {
                        case '24h': start = moment().subtract(24, 'hours'); break;
                        case '7d': start = moment().subtract(7, 'days').startOf('day'); break;
                        case '30d': start = moment().subtract(30, 'days').startOf('day'); break;
                        case 'all': start = moment('2020-01-01'); break;
                        default: start = moment().subtract(7, 'days').startOf('day');
                    }

                    filters.value = { startDate: start, endDate: end };

                    // Log filter change for debugging
                    console.log('Filter changed to:', period, {
                        start: start.format('YYYY-MM-DD HH:mm'),
                        end: end.format('YYYY-MM-DD HH:mm')
                    });

                    updateCharts();
                };

                const fetchData = async () => {
                    if (!canUpdate.value) return;

                    loading.value = true;
                    lastUpdateTime.value = Date.now();

                    try {
                        const api = axios.create({
                            baseURL: baseUrl.value,
                            headers: {
                                "ngrok-skip-browser-warning": "true"
                            }
                        });

                        const execRes = await api.get('/executions/?page_size=100');
                        const rawExecutions = Array.isArray(execRes.data.results)
                            ? execRes.data.results
                            : Array.isArray(execRes.data)
                                ? execRes.data
                                : [];

                        const successfulExecutions = rawExecutions.filter(
                            (e) => e.status === 'SUCCESS' && e.summary
                        );
                        const executionsForCards = successfulExecutions.length ? successfulExecutions : rawExecutions;

                        if (executionsForCards.length > 0) {
                            latestExecution.value = executionsForCards[0];
                            const detailRes = await api.get(`/executions/${latestExecution.value.id}/`);
                            latestExecutionDetails.value = detailRes.data;
                        }

                        const chartExecutions = successfulExecutions.length ? successfulExecutions : rawExecutions;
                        executions.value = [...chartExecutions].sort((a, b) => {
                            return moment(a.created_at, "YYYY-MM-DD HH:mm").diff(moment(b.created_at, "YYYY-MM-DD HH:mm"));
                        });

                        const opsRes = await api.get('/operations/?page_size=100');
                        operations.value = opsRes.data.results || opsRes.data;
                        operations.value.sort((a, b) => moment(b.created_at, "YYYY-MM-DD HH:mm").diff(moment(a.created_at, "YYYY-MM-DD HH:mm")));

                        updateCharts();

                    } catch (error) {
                        console.error(`Error fetching data from ${baseUrl.value}:`, error);
                    } finally {
                        loading.value = false;
                    }
                };

                const updateCharts = () => {
                    if (!executions.value || executions.value.length === 0) {
                        console.log('No executions data available for charts');
                        return;
                    }

                    const dataPoints = executions.value.filter(e => {
                        const date = moment(e.created_at, "YYYY-MM-DD HH:mm");
                        const isInRange = date.isSameOrAfter(filters.value.startDate) && date.isSameOrBefore(filters.value.endDate);
                        return isInRange;
                    });

                    console.log(`Filtered ${dataPoints.length} data points from ${executions.value.length} total executions`);

                    updateBalanceChart(dataPoints);
                    updatePerformanceChart(dataPoints);
                    updatePnlChart(dataPoints);
                    updateActivityChart(dataPoints);
                };

                const getChartColors = () => ({
                    sage: '#8EB69B',
                    mint: '#DAF1DE',
                    medium: '#163832',
                    accent: '#235347',
                    dark: '#0B2B26',
                    error: '#D46B6B'
                });

                const updateBalanceChart = (dataPoints) => {
                    const ctx = document.getElementById('balanceChart')?.getContext('2d');
                    if (!ctx) return;

                    if (chartInstances.value.balance) chartInstances.value.balance.destroy();

                    const colors = getChartColors();

                    chartInstances.value.balance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dataPoints.map(e => moment(e.created_at, "YYYY-MM-DD HH:mm").toISOString()),
                            datasets: [{
                                label: 'Balance Total',
                                data: dataPoints.map(e => e.summary?.total_balance || 0),
                                borderColor: colors.sage,
                                backgroundColor: (context) => {
                                    const chart = context.chart;
                                    const { ctx, chartArea } = chart;
                                    if (!chartArea) return colors.sage;
                                    const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                                    gradient.addColorStop(0, 'rgba(142, 182, 155, 0)');
                                    gradient.addColorStop(1, 'rgba(142, 182, 155, 0.3)');
                                    return gradient;
                                },
                                tension: 0.4,
                                fill: true,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                pointHoverBackgroundColor: colors.mint,
                                pointHoverBorderColor: colors.sage,
                                pointHoverBorderWidth: 2,
                                borderWidth: 3
                            }]
                        },
                        options: getChartOptions('Balance (USDT)')
                    });
                };

                const updatePerformanceChart = (dataPoints) => {
                    const ctx = document.getElementById('performanceChart')?.getContext('2d');
                    if (!ctx) return;

                    if (chartInstances.value.performance) chartInstances.value.performance.destroy();

                    const colors = getChartColors();

                    chartInstances.value.performance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dataPoints.map(e => moment(e.created_at, "YYYY-MM-DD HH:mm").toISOString()),
                            datasets: [{
                                label: 'Win Rate',
                                data: dataPoints.map(e => e.summary?.win_rate || 0),
                                borderColor: '#b794f4',
                                backgroundColor: (context) => {
                                    const chart = context.chart;
                                    const { ctx, chartArea } = chart;
                                    if (!chartArea) return '#b794f4';
                                    const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                                    gradient.addColorStop(0, 'rgba(183, 148, 244, 0)');
                                    gradient.addColorStop(1, 'rgba(183, 148, 244, 0.3)');
                                    return gradient;
                                },
                                tension: 0.4,
                                fill: true,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                pointHoverBackgroundColor: '#e9d8fd',
                                pointHoverBorderColor: '#b794f4',
                                pointHoverBorderWidth: 2,
                                borderWidth: 3,
                                yAxisID: 'y'
                            }]
                        },
                        options: getChartOptions('Win Rate (%)', 0, 100)
                    });
                };

                const updatePnlChart = (dataPoints) => {
                    const ctx = document.getElementById('pnlChart')?.getContext('2d');
                    if (!ctx) return;

                    if (chartInstances.value.pnl) chartInstances.value.pnl.destroy();

                    const colors = getChartColors();

                    chartInstances.value.pnl = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: dataPoints.map(e => moment(e.created_at, "YYYY-MM-DD HH:mm").toISOString()),
                            datasets: [{
                                label: 'PnL Diario',
                                data: dataPoints.map(e => e.summary?.daily_pnl || 0),
                                backgroundColor: dataPoints.map(e => (e.summary?.daily_pnl || 0) >= 0 ? 'rgba(142, 182, 155, 0.8)' : 'rgba(212, 107, 107, 0.8)'),
                                borderColor: dataPoints.map(e => (e.summary?.daily_pnl || 0) >= 0 ? colors.sage : colors.error),
                                borderWidth: 1,
                                borderRadius: 6,
                                borderSkipped: false
                            }]
                        },
                        options: getChartOptions('PnL (USDT)')
                    });
                };

                const updateActivityChart = (dataPoints) => {
                    const ctx = document.getElementById('activityChart')?.getContext('2d');
                    if (!ctx) return;

                    if (chartInstances.value.activity) chartInstances.value.activity.destroy();

                    chartInstances.value.activity = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: dataPoints.map(e => moment(e.created_at, "YYYY-MM-DD HH:mm").toISOString()),
                            datasets: [{
                                label: 'Número de Trades',
                                data: dataPoints.map(e => e.summary?.trade_count || 0),
                                backgroundColor: 'rgba(236, 201, 75, 0.8)',
                                borderColor: '#ecc94b',
                                borderWidth: 1,
                                borderRadius: 6,
                                borderSkipped: false
                            }]
                        },
                        options: getChartOptions('Trades', 0)
                    });
                };

                const getChartOptions = (yLabel, suggestedMin, suggestedMax) => ({
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#0B2B26',
                            titleColor: '#DAF1DE',
                            bodyColor: '#8EB69B',
                            borderColor: '#235347',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            cornerRadius: 12
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', displayFormats: { hour: 'MMM D, HH:mm' } },
                            grid: { color: 'rgba(35, 83, 71, 0.3)', drawBorder: false },
                            ticks: { color: '#8EB69B', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(35, 83, 71, 0.3)', drawBorder: false },
                            ticks: { color: '#8EB69B', font: { size: 10 } },
                            title: { display: false },
                            suggestedMin: suggestedMin,
                            suggestedMax: suggestedMax
                        }
                    }
                });

                const formatMoney = (val) => val ? Number(val).toFixed(2) : '0.00';
                const formatDateTime = (date) => moment(date).format('MMM D, HH:mm');

                const getRsiColor = (rsi) => {
                    if (rsi >= 70) return 'var(--c-error)';
                    if (rsi <= 30) return 'var(--c-sage)';
                    return 'var(--c-sage)';
                };

                const renderMarkdown = (text) => text ? marked.parse(text) : '';

                onMounted(() => {
                    fetchData();
                    // Actualizar el temporizador cada segundo
                    setInterval(() => {
                        if (!canUpdate.value) {
                            // Forzar actualización de computeds
                            timeUntilNextUpdate.value;
                        }
                    }, 1000);
                });

                return {
                    baseUrl,
                    loading,
                    sidebarOpen,
                    executions,
                    operations,
                    latestExecution,
                    latestExecutionDetails,
                    activeFilter,
                    currentDate,
                    getDailyPnl,
                    getDailyPnlPercent,
                    fetchData,
                    setFilter,
                    toggleSidebar,
                    formatMoney,
                    formatDateTime,
                    getRsiColor,
                    renderMarkdown,
                    canUpdate,
                    updateButtonText
                };
            }
        }).mount('#app');
    </script>
    {% endverbatim %}
</body>

</html>